#!/bin/bash

# √úberpr√ºfen, ob Whiptail installiert ist, und falls nicht, es installieren
if ! command -v whiptail &> /dev/null; then
    echo "Whiptail ist nicht installiert. Installiere Whiptail..."
    
    # Je nach Paketverwaltungssystem die Installation durchf√ºhren
    if command -v apt-get &> /dev/null; then
        sudo apt-get update
        sudo apt-get install -y whiptail
    elif command -v dnf &> /dev/null; then
        sudo dnf install -y newt
    elif command -v yum &> /dev/null; then
        sudo yum install -y newt
    else
        echo "Paketverwaltungssystem nicht erkannt. Bitte installieren Sie Whiptail manuell."
        exit 1
    fi
fi

# Kopfzeile f√ºr die Pterodactyl Panel Installation anzeigen
echo "----------------------------------"
echo "Pterodactyl Panel Installation"
echo "----------------------------------"
sleep 3  # 3 Sekunden warten, bevor das Skript fortgesetzt wird

# Konfiguration von dpkg
echo "‚öôÔ∏è Konfiguration von dpkg..."
sudo dpkg --configure -a

# Installieren der erforderlichen Pakete
echo "‚öôÔ∏è Installation der erforderlichen Pakete..."
sudo apt-get update
sudo apt-get install -y dnsutils curl openssl

# Befehlszeile leeren
clear

# Anzeige einer Whiptail-GUI zur Eingabe der Panel-Domain
panel_domain=$(whiptail --inputbox "Bitte gebe die Domain/FQDN f√ºr das Panel ein:" 10 50 3>&1 1>&2 2>&3)
if [ $? -ne 0 ]; then
    echo "Abbruch durch Benutzer."
    exit 1
fi

# IP-Adresse des Servers
server_ip=$(hostname -I | awk '{print $1}')
clear
echo "Es wird gepr√ºft, ob die Domain mit der IP korrekt verbunden wurde..."
sleep 5

# IP-Adresse aus dem DNS-A-Eintrag der Domain extrahieren
dns_ip=$(dig +short $panel_domain)

if [ "$dns_ip" == "$server_ip" ]; then
    echo "‚úÖ Die Domain $panel_domain zeigt auf diese Server-IP ($server_ip). Installation wird fortgesetzt."
else
    echo "‚ùå Die Domain $panel_domain ist mit eine andere IP-Adresse verbunden ($dns_ip). Pr√ºfe, ob die DNS-Eintr√§ge richtig sind und ob du in Cloudflare den Proxy deaktiviert hast. Die Installation wird abgebrochen."
    exit 1
fi

# Anzeige einer Whiptail-GUI zur Eingabe der E-Mail-Adresse
admin_email=$(whiptail --inputbox "Bitte gebe die E-Mail-Adresse f√ºr das SSL-Zertifikat und den Admin-Benutzer ein:" 10 50 3>&1 1>&2 2>&3)
if [ $? -ne 0 ]; then
    echo "Abbruch durch Benutzer."
    exit 1
fi

# Funktion zum Generieren eines 64 Zeichen langen zuf√§lligen Passworts ohne Sonderzeichen
generate_password() {
    < /dev/urandom tr -dc A-Za-z0-9 | head -c64
}

user_password=$(generate_password)

echo "Bitte warten Sie, bis die Installation abgeschlossen ist..."
sleep 2  # 2 Sekunden warten

# Installation des Panels
bash <(curl -s https://pterodactyl-installer.se) <<EOF
0
panel
pterodactyl
$user_password
Europe/Berlin
$admin_email
$admin_email
user
Admin
User
$user_password
$panel_domain
N
N
N
y
yes
EOF

# Update und Installation von certbot
echo "‚öôÔ∏è Update und Installation von Certbot..."
sudo apt-get update && sudo apt-get install certbot python3-certbot-nginx -y

# Stoppen von nginx
echo "‚öôÔ∏è Stoppen von Nginx..."
sudo systemctl stop nginx

# SSL-Zertifikat mit Certbot erstellen und Nginx konfigurieren
echo "‚öôÔ∏è SSL-Zertifikat erstellen und Nginx konfigurieren..."
sudo certbot --nginx -d $panel_domain --email $admin_email --agree-tos --non-interactive

# Freigabe von Port 80 und Port 443
echo "‚öôÔ∏è Freigabe von Port 80 und Port 443..."
sudo fuser -k 80/tcp
sudo fuser -k 443/tcp

# Neustarten von nginx
echo "‚öôÔ∏è Neustarten von Nginx..."
sudo systemctl start nginx

# Erfolgreiche Installationsnachricht in zugangsdaten.txt speichern
echo "-----------------------------------------------------------------------------------" > zugangsdaten.txt
echo "Installation des Panels erfolgreich." >> zugangsdaten.txt
echo "üåê Die verwendete Domain ist: $panel_domain" >> zugangsdaten.txt
echo "üîë Ihre generierten Zugangsdaten sind:" >> zugangsdaten.txt
echo "üë§ Benutzername: User" >> zugangsdaten.txt
echo "üîí Passwort (64 Zeichen): $user_password" >> zugangsdaten.txt
echo "-----------------------------------------------------------------------------------" >> zugangsdaten.txt

echo "Die Zugangsdaten wurden in die Datei 'zugangsdaten.txt' gespeichert."
